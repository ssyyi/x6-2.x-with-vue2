!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@antv/x6")):"function"==typeof define&&define.amd?define(["exports","@antv/x6"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).X6PluginStencil={},t.X6)}(this,(function(t,e){"use strict";var n,i=function(t,e,n,i){var o,s=arguments.length,a=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,i);else for(var r=t.length-1;r>=0;r--)(o=t[r])&&(a=(s<3?o(a):s>3?o(e,n,a):o(e,n))||a);return s>3&&a&&Object.defineProperty(e,n,a),a};class o extends e.View{get targetScroller(){return this.options.target.getPlugin("scroller")}get targetGraph(){return this.options.target}get targetModel(){return this.targetGraph.model}get snapline(){return this.options.target.getPlugin("snapline")}constructor(t){super(),this.name="dnd",this.options=Object.assign(Object.assign({},o.defaults),t),this.init()}init(){e.CssLoader.ensure(this.name,".x6-widget-dnd {\n  position: absolute;\n  top: -10000px;\n  left: -10000px;\n  z-index: 999999;\n  display: none;\n  cursor: move;\n  opacity: 0.7;\n  pointer-events: 'cursor';\n}\n.x6-widget-dnd.dragging {\n  display: inline-block;\n}\n.x6-widget-dnd.dragging * {\n  pointer-events: none !important;\n}\n.x6-widget-dnd .x6-graph {\n  background: transparent;\n  box-shadow: none;\n}\n"),this.container=document.createElement("div"),e.Dom.addClass(this.container,this.prefixClassName("widget-dnd")),this.draggingGraph=new e.Graph(Object.assign(Object.assign({},this.options.delegateGraphOptions),{container:document.createElement("div"),width:1,height:1,async:!1})),e.Dom.append(this.container,this.draggingGraph.container)}start(t,n){const i=n;i.preventDefault(),this.targetModel.startBatch("dnd"),e.Dom.addClass(this.container,"dragging"),e.Dom.appendTo(this.container,this.options.draggingContainer||document.body),this.sourceNode=t,this.prepareDragging(t,i.clientX,i.clientY);const s=this.updateNodePosition(i.clientX,i.clientY);this.isSnaplineEnabled()&&(this.snapline.captureCursorOffset({e:i,node:t,cell:t,view:this.draggingView,x:s.x,y:s.y}),this.draggingNode.on("change:position",this.snap,this)),this.delegateDocumentEvents(o.documentEvents,i.data)}isSnaplineEnabled(){return this.snapline&&this.snapline.isEnabled()}prepareDragging(t,e,n){const i=this.draggingGraph,o=i.model,s=this.options.getDragNode(t,{sourceNode:t,draggingGraph:i,targetGraph:this.targetGraph});s.position(0,0);let a=5;if(this.isSnaplineEnabled()&&(a+=this.snapline.options.tolerance||0),this.isSnaplineEnabled()||this.options.scaled){const t=this.targetGraph.transform.getScale();i.scale(t.sx,t.sy),a*=Math.max(t.sx,t.sy)}else i.scale(1,1);this.clearDragging(),o.resetCells([s]);const r=i.findViewByCell(s);r.undelegateEvents(),r.cell.off("changed"),i.fitToContent({padding:a,allowNewOrigin:"any",useCellGeometry:!1});const l=r.getBBox();this.geometryBBox=r.getBBox({useCellGeometry:!0}),this.delta=this.geometryBBox.getTopLeft().diff(l.getTopLeft()),this.draggingNode=s,this.draggingView=r,this.draggingBBox=s.getBBox(),this.padding=a,this.originOffset=this.updateGraphPosition(e,n)}updateGraphPosition(t,n){const i=document.body.scrollTop||document.documentElement.scrollTop,o=this.delta,s=this.geometryBBox,a=this.padding||5,r={left:t-o.x-s.width/2-a,top:n-o.y-s.height/2-a+i};return this.draggingGraph&&e.Dom.css(this.container,{left:`${r.left}px`,top:`${r.top}px`}),r}updateNodePosition(t,e){const n=this.targetGraph.clientToLocal(t,e),i=this.draggingBBox;return n.x-=i.width/2,n.y-=i.height/2,this.draggingNode.position(n.x,n.y),n}snap({cell:t,current:e,options:n}){const i=t;if(n.snapped){const t=this.draggingBBox;i.position(t.x+n.tx,t.y+n.ty,{silent:!0}),this.draggingView.translate(),i.position(e.x,e.y,{silent:!0}),this.snapOffset={x:n.tx,y:n.ty}}else this.snapOffset=null}onDragging(t){const e=this.draggingView;if(e){t.preventDefault();const n=this.normalizeEvent(t),i=n.clientX,o=n.clientY;this.updateGraphPosition(i,o);const s=this.updateNodePosition(i,o),a=this.targetGraph.options.embedding.enabled,r=(a||this.isSnaplineEnabled())&&this.isInsideValidArea({x:i,y:o});if(a){e.setEventData(n,{graph:this.targetGraph,candidateEmbedView:this.candidateEmbedView});const t=e.getEventData(n);r?e.processEmbedding(n,t):e.clearEmbedding(t),this.candidateEmbedView=t.candidateEmbedView}this.isSnaplineEnabled()&&(r?this.snapline.snapOnMoving({e:n,view:e,x:s.x,y:s.y}):this.snapline.hide())}}onDragEnd(t){const n=this.draggingNode;if(n){const i=this.normalizeEvent(t),o=this.draggingView,s=this.draggingBBox,a=this.snapOffset;let r=s.x,l=s.y;a&&(r+=a.x,l+=a.y),n.position(r,l,{silent:!0});const d=this.drop(n,{x:i.clientX,y:i.clientY}),g=t=>{t?(this.onDropped(n),this.targetGraph.options.embedding.enabled&&o&&(o.setEventData(i,{cell:t,graph:this.targetGraph,candidateEmbedView:this.candidateEmbedView}),o.finalizeEmbedding(i,o.getEventData(i)))):this.onDropInvalid(),this.candidateEmbedView=null,this.targetModel.stopBatch("dnd")};e.FunctionExt.isAsync(d)?(this.undelegateDocumentEvents(),d.then(g)):g(d)}}clearDragging(){this.draggingNode&&(this.sourceNode=null,this.draggingNode.remove(),this.draggingNode=null,this.draggingView=null,this.delta=null,this.padding=null,this.snapOffset=null,this.originOffset=null,this.undelegateDocumentEvents())}onDropped(t){this.draggingNode===t&&(this.clearDragging(),e.Dom.removeClass(this.container,"dragging"),e.Dom.remove(this.container))}onDropInvalid(){const t=this.draggingNode;t&&this.onDropped(t)}isInsideValidArea(t){let e,n=null;const i=this.targetGraph,o=this.targetScroller;this.options.dndContainer&&(n=this.getDropArea(this.options.dndContainer));const s=n&&n.containsPoint(t);if(o)if(o.options.autoResize)e=this.getDropArea(o.container);else{const t=this.getDropArea(o.container);e=this.getDropArea(i.container).intersectsWithRect(t)}else e=this.getDropArea(i.container);return!s&&e&&e.containsPoint(t)}getDropArea(t){const n=e.Dom.offset(t),i=document.body.scrollTop||document.documentElement.scrollTop,o=document.body.scrollLeft||document.documentElement.scrollLeft;return e.Rectangle.create({x:n.left+parseInt(e.Dom.css(t,"border-left-width"),10)-o,y:n.top+parseInt(e.Dom.css(t,"border-top-width"),10)-i,width:t.clientWidth,height:t.clientHeight})}drop(t,n){if(this.isInsideValidArea(n)){const i=this.targetGraph,o=i.model,s=i.clientToLocal(n),a=this.sourceNode,r=this.options.getDropNode(t,{sourceNode:a,draggingNode:t,targetGraph:this.targetGraph,draggingGraph:this.draggingGraph}),l=r.getBBox();s.x+=l.x-l.width/2,s.y+=l.y-l.height/2;const d=this.snapOffset?1:i.getGridSize();r.position(e.GeometryUtil.snapToGrid(s.x,d),e.GeometryUtil.snapToGrid(s.y,d)),r.removeZIndex();const g=this.options.validateNode,p=!g||g(r,{sourceNode:a,draggingNode:t,droppingNode:r,targetGraph:i,draggingGraph:this.draggingGraph});return"boolean"==typeof p?p?(o.addCell(r,{stencil:this.cid}),r):null:e.FunctionExt.toDeferredBoolean(p).then((t=>t?(o.addCell(r,{stencil:this.cid}),r):null))}return null}onRemove(){this.draggingGraph&&(this.draggingGraph.view.remove(),this.draggingGraph.dispose())}dispose(){this.remove(),e.CssLoader.clean(this.name)}}i([e.View.dispose()],o.prototype,"dispose",null),function(t){t.defaults={getDragNode:t=>t.clone(),getDropNode:t=>t.clone()},t.documentEvents={mousemove:"onDragging",touchmove:"onDragging",mouseup:"onDragEnd",touchend:"onDragEnd",touchcancel:"onDragEnd"}}(o||(o={})),function(t){t.getMaxDim=function(t,e){return t.reduce(((t,n)=>Math.max(null==n?void 0:n.getSize()[e],t)),0)},t.getNodesInRow=function(t,e,n){const i=[];for(let o=n*e,s=o+n;o<s;o+=1)t[o]&&i.push(t[o]);return i},t.getNodesInColumn=function(t,e,n){const i=[];for(let o=e,s=t.length;o<s;o+=n)t[o]&&i.push(t[o]);return i},t.accumulate=function(t,e){return t.reduce(((t,e,n)=>(t.push(t[n]+e),t)),[e||0])}}(n||(n={}));class s extends e.View{get targetScroller(){return this.options.target.getPlugin("scroller")}get targetGraph(){return this.options.target}get targetModel(){return this.targetGraph.model}constructor(t={}){super(),this.name="stencil",e.CssLoader.ensure(this.name,".x6-widget-dnd {\n  position: absolute;\n  top: -10000px;\n  left: -10000px;\n  z-index: 999999;\n  display: none;\n  cursor: move;\n  opacity: 0.7;\n  pointer-events: 'cursor';\n}\n.x6-widget-dnd.dragging {\n  display: inline-block;\n}\n.x6-widget-dnd.dragging * {\n  pointer-events: none !important;\n}\n.x6-widget-dnd .x6-graph {\n  background: transparent;\n  box-shadow: none;\n}\n.x6-widget-stencil {\n  position: absolute;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n}\n.x6-widget-stencil::after {\n  position: absolute;\n  top: 0;\n  display: block;\n  width: 100%;\n  height: 20px;\n  padding: 8px 0;\n  line-height: 20px;\n  text-align: center;\n  opacity: 0;\n  transition: top 0.1s linear, opacity 0.1s linear;\n  content: ' ';\n  pointer-events: none;\n}\n.x6-widget-stencil-content {\n  position: absolute;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  height: auto;\n  overflow-x: hidden;\n  overflow-y: auto;\n}\n.x6-widget-stencil .x6-node [magnet]:not([magnet='passive']) {\n  pointer-events: none;\n}\n.x6-widget-stencil-group {\n  padding: 0;\n  padding-bottom: 8px;\n  overflow: hidden;\n  user-select: none;\n}\n.x6-widget-stencil-group.collapsed {\n  height: auto;\n  padding-bottom: 0;\n}\n.x6-widget-stencil-group-title {\n  position: relative;\n  margin-top: 0;\n  margin-bottom: 0;\n  padding: 4px;\n  cursor: pointer;\n}\n.x6-widget-stencil-title,\n.x6-widget-stencil-group > .x6-widget-stencil-group-title {\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  user-select: none;\n}\n.x6-widget-stencil .unmatched {\n  opacity: 0.3;\n}\n.x6-widget-stencil .x6-node.unmatched {\n  display: none;\n}\n.x6-widget-stencil-group.unmatched {\n  display: none;\n}\n.x6-widget-stencil-search-text {\n  position: relative;\n  z-index: 1;\n  box-sizing: border-box;\n  width: 100%;\n  height: 30px;\n  max-height: 30px;\n  line-height: 30px;\n  outline: 0;\n}\n.x6-widget-stencil.not-found::after {\n  opacity: 1;\n  content: attr(data-not-found-text);\n}\n.x6-widget-stencil.not-found.searchable::after {\n  top: 30px;\n}\n.x6-widget-stencil.not-found.searchable.collapsable::after {\n  top: 50px;\n}\n.x6-widget-stencil {\n  color: #333;\n  background: #f5f5f5;\n}\n.x6-widget-stencil-content {\n  position: absolute;\n}\n.x6-widget-stencil.collapsable > .x6-widget-stencil-content {\n  top: 32px;\n}\n.x6-widget-stencil.searchable > .x6-widget-stencil-content {\n  top: 80px;\n}\n.x6-widget-stencil.not-found::after {\n  position: absolute;\n}\n.x6-widget-stencil.not-found.searchable.collapsable::after {\n  top: 80px;\n}\n.x6-widget-stencil.not-found.searchable::after {\n  top: 60px;\n}\n.x6-widget-stencil-group {\n  height: auto;\n  margin-bottom: 1px;\n  padding: 0;\n  transition: none;\n}\n.x6-widget-stencil-group .x6-graph {\n  background: transparent;\n  box-shadow: none;\n}\n.x6-widget-stencil-group.collapsed {\n  height: auto;\n  max-height: 31px;\n}\n.x6-widget-stencil-title,\n.x6-widget-stencil-group > .x6-widget-stencil-group-title {\n  position: relative;\n  left: 0;\n  box-sizing: border-box;\n  width: 100%;\n  height: 32px;\n  padding: 0 5px 0 8px;\n  color: #666;\n  font-weight: 700;\n  font-size: 12px;\n  line-height: 32px;\n  cursor: default;\n  transition: all 0.3;\n}\n.x6-widget-stencil-title:hover,\n.x6-widget-stencil-group > .x6-widget-stencil-group-title:hover {\n  color: #444;\n}\n.x6-widget-stencil-title {\n  background: #e9e9e9;\n}\n.x6-widget-stencil-group > .x6-widget-stencil-group-title {\n  background: #ededed;\n}\n.x6-widget-stencil.collapsable > .x6-widget-stencil-title,\n.x6-widget-stencil-group.collapsable > .x6-widget-stencil-group-title {\n  padding-left: 32px;\n  cursor: pointer;\n}\n.x6-widget-stencil.collapsable > .x6-widget-stencil-title::before,\n.x6-widget-stencil-group.collapsable > .x6-widget-stencil-group-title::before {\n  position: absolute;\n  top: 6px;\n  left: 8px;\n  display: block;\n  width: 18px;\n  height: 18px;\n  margin: 0;\n  padding: 0;\n  background-color: transparent;\n  background-repeat: no-repeat;\n  background-position: 0 0;\n  border: none;\n  content: ' ';\n}\n.x6-widget-stencil.collapsable > .x6-widget-stencil-title::before,\n.x6-widget-stencil-group.collapsable > .x6-widget-stencil-group-title::before {\n  background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0iIzAwMCIgZmlsbC1ydWxlPSJub256ZXJvIj48cGF0aCBkPSJNOS4zNzUuNUM0LjY4Ny41Ljg3NSA0LjMxMy44NzUgOWMwIDQuNjg4IDMuODEyIDguNSA4LjUgOC41IDQuNjg3IDAgOC41LTMuODEyIDguNS04LjUgMC00LjY4Ny0zLjgxMy04LjUtOC41LTguNXptMCAxNS44ODZDNS4zMDMgMTYuMzg2IDEuOTkgMTMuMDcyIDEuOTkgOXMzLjMxMi03LjM4NSA3LjM4NS03LjM4NVMxNi43NiA0LjkyOCAxNi43NiA5YzAgNC4wNzItMy4zMTMgNy4zODYtNy4zODUgNy4zODZ6Ii8+PHBhdGggZD0iTTEyLjc1MyA4LjQ0M0g1Ljk5N2EuNTU4LjU1OCAwIDAwMCAxLjExNmg2Ljc1NmEuNTU4LjU1OCAwIDAwMC0xLjExNnoiLz48L2c+PC9zdmc+');\n  opacity: 0.4;\n  transition: all 0.3s;\n}\n.x6-widget-stencil.collapsable > .x6-widget-stencil-title:hover::before,\n.x6-widget-stencil-group.collapsable > .x6-widget-stencil-group-title:hover::before {\n  opacity: 0.6;\n}\n.x6-widget-stencil.collapsable.collapsed > .x6-widget-stencil-title::before,\n.x6-widget-stencil-group.collapsable.collapsed > .x6-widget-stencil-group-title::before {\n  background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0iIzAwMCIgZmlsbC1ydWxlPSJub256ZXJvIj48cGF0aCBkPSJNOS4zNzUuNUM0LjY4Ny41Ljg3NSA0LjMxMy44NzUgOWMwIDQuNjg4IDMuODEyIDguNSA4LjUgOC41IDQuNjg3IDAgOC41LTMuODEyIDguNS04LjUgMC00LjY4Ny0zLjgxMy04LjUtOC41LTguNXptMCAxNS44ODZDNS4zMDMgMTYuMzg2IDEuOTkgMTMuMDcyIDEuOTkgOXMzLjMxMi03LjM4NSA3LjM4NS03LjM4NVMxNi43NiA0LjkyOCAxNi43NiA5YzAgNC4wNzItMy4zMTMgNy4zODYtNy4zODUgNy4zODZ6Ii8+PHBhdGggZD0iTTEyLjc1MyA4LjQ0M0g1Ljk5N2EuNTU4LjU1OCAwIDAwMCAxLjExNmg2Ljc1NmEuNTU4LjU1OCAwIDAwMC0xLjExNnoiLz48cGF0aCBkPSJNOC44MTcgNS42MjN2Ni43NTZhLjU1OC41NTggMCAwMDEuMTE2IDBWNS42MjNhLjU1OC41NTggMCAxMC0xLjExNiAweiIvPjwvZz48L3N2Zz4=');\n  opacity: 0.4;\n}\n.x6-widget-stencil.collapsable.collapsed > .x6-widget-stencil-title:hover::before,\n.x6-widget-stencil-group.collapsable.collapsed > .x6-widget-stencil-group-title:hover::before {\n  opacity: 0.6;\n}\n.x6-widget-stencil input[type='search'] {\n  appearance: textfield;\n}\n.x6-widget-stencil input[type='search']::-webkit-search-cancel-button,\n.x6-widget-stencil input[type='search']::-webkit-search-decoration {\n  appearance: none;\n}\n.x6-widget-stencil-search-text {\n  display: block;\n  width: 90%;\n  margin: 8px 5%;\n  padding-left: 8px;\n  color: #333;\n  background: #fff;\n  border: 1px solid #e9e9e9;\n  border-radius: 12px;\n  outline: 0;\n}\n.x6-widget-stencil-search-text:focus {\n  outline: 0;\n}\n.x6-widget-stencil::after {\n  color: #808080;\n  font-weight: 600;\n  font-size: 12px;\n  background: 0 0;\n}\n"),this.graphs={},this.groups={},this.options=Object.assign(Object.assign({},s.defaultOptions),t),this.init()}init(){this.dnd=new o(this.options),this.onSearch=e.FunctionExt.debounce(this.onSearch,200),this.initContainer(),this.initSearch(),this.initContent(),this.initGroups(),this.setTitle(),this.startListening()}load(t,e){return Array.isArray(t)?this.loadGroup(t,e):this.options.groups&&Object.keys(this.options.groups).forEach((e=>{t[e]&&this.loadGroup(t[e],e)})),this}unload(t,e){return Array.isArray(t)?this.loadGroup(t,e,!0):this.options.groups&&Object.keys(this.options.groups).forEach((e=>{t[e]&&this.loadGroup(t[e],e,!0)})),this}toggleGroup(t){return this.isGroupCollapsed(t)?this.expandGroup(t):this.collapseGroup(t),this}collapseGroup(t){if(this.isGroupCollapsable(t)){const n=this.groups[t];n&&!this.isGroupCollapsed(t)&&(this.trigger("group:collapse",{name:t}),e.Dom.addClass(n,"collapsed"))}return this}expandGroup(t){if(this.isGroupCollapsable(t)){const n=this.groups[t];n&&this.isGroupCollapsed(t)&&(this.trigger("group:expand",{name:t}),e.Dom.removeClass(n,"collapsed"))}return this}isGroupCollapsable(t){const n=this.groups[t];return e.Dom.hasClass(n,"collapsable")}isGroupCollapsed(t){const n=this.groups[t];return n&&e.Dom.hasClass(n,"collapsed")}collapseGroups(){return Object.keys(this.groups).forEach((t=>this.collapseGroup(t))),this}expandGroups(){return Object.keys(this.groups).forEach((t=>this.expandGroup(t))),this}resizeGroup(t,e){const n=this.graphs[t];return n&&n.resize(e.width,e.height),this}addGroup(t){const e=Array.isArray(t)?t:[t];this.options.groups?this.options.groups.push(...e):this.options.groups=e,e.forEach((t=>this.initGroup(t)))}removeGroup(t){const n=Array.isArray(t)?t:[t];this.options.groups&&(this.options.groups=this.options.groups.filter((t=>!n.includes(t.name))),n.forEach((t=>{this.graphs[t].dispose(),delete this.graphs[t];const n=this.groups[t];e.Dom.remove(n),delete this.groups[t]})))}initContainer(){this.container=document.createElement("div"),e.Dom.addClass(this.container,this.prefixClassName(a.base)),e.Dom.attr(this.container,"data-not-found-text",this.options.notFoundText||"No matches found")}initContent(){this.content=document.createElement("div"),e.Dom.addClass(this.content,this.prefixClassName(a.content)),e.Dom.appendTo(this.content,this.container)}initSearch(){this.options.search&&(e.Dom.addClass(this.container,"searchable"),e.Dom.append(this.container,this.renderSearch()))}initGroup(t){const n=this.options.stencilGraphOptions||{},i=document.createElement("div");e.Dom.addClass(i,this.prefixClassName(a.group)),e.Dom.attr(i,"data-name",t.name),(null==t.collapsable&&this.options.collapsable||!1!==t.collapsable)&&e.Dom.addClass(i,"collapsable"),e.Dom.toggleClass(i,"collapsed",!0===t.collapsed);const o=document.createElement("h3");e.Dom.addClass(o,this.prefixClassName(a.groupTitle)),o.innerHTML=t.title||t.name;const s=document.createElement("div");e.Dom.addClass(s,this.prefixClassName(a.groupContent));const r=t.graphOptions,l=new e.Graph(Object.assign(Object.assign(Object.assign({},n),r),{container:document.createElement("div"),model:n.model||new e.Model,width:t.graphWidth||this.options.stencilGraphWidth,height:t.graphHeight||this.options.stencilGraphHeight,interacting:!1,preventDefaultBlankAction:!1}));e.Dom.append(s,l.container),e.Dom.append(i,[o,s]),e.Dom.appendTo(i,this.content),this.groups[t.name]=i,this.graphs[t.name]=l}initGroups(){if(this.clearGroups(),this.setCollapsableState(),this.options.groups&&this.options.groups.length)this.options.groups.forEach((t=>{this.initGroup(t)}));else{const t=this.options.stencilGraphOptions||{},n=new e.Graph(Object.assign(Object.assign({},t),{container:document.createElement("div"),model:t.model||new e.Model,width:this.options.stencilGraphWidth,height:this.options.stencilGraphHeight,interacting:!1,preventDefaultBlankAction:!1}));e.Dom.append(this.content,n.container),this.graphs[r.defaultGroupName]=n}}setCollapsableState(){if(this.options.collapsable=this.options.collapsable&&this.options.groups&&this.options.groups.some((t=>!1!==t.collapsable)),this.options.collapsable){e.Dom.addClass(this.container,"collapsable");this.options.groups&&this.options.groups.every((t=>t.collapsed||!1===t.collapsable))?e.Dom.addClass(this.container,"collapsed"):e.Dom.removeClass(this.container,"collapsed")}else e.Dom.removeClass(this.container,"collapsable")}setTitle(){const t=document.createElement("div");e.Dom.addClass(t,this.prefixClassName(a.title)),t.innerHTML=this.options.title,e.Dom.appendTo(t,this.container)}renderSearch(){const t=document.createElement("div");e.Dom.addClass(t,this.prefixClassName(a.search));const n=document.createElement("input");return e.Dom.attr(n,{type:"search",placeholder:this.options.placeholder||"Search"}),e.Dom.addClass(n,this.prefixClassName(a.searchText)),e.Dom.append(t,n),t}startListening(){const t=this.prefixClassName(a.title),e=this.prefixClassName(a.searchText),n=this.prefixClassName(a.groupTitle);this.delegateEvents({[`click .${t}`]:"onTitleClick",[`touchstart .${t}`]:"onTitleClick",[`click .${n}`]:"onGroupTitleClick",[`touchstart .${n}`]:"onGroupTitleClick",[`input .${e}`]:"onSearch",[`focusin .${e}`]:"onSearchFocusIn",[`focusout .${e}`]:"onSearchFocusOut"}),Object.keys(this.graphs).forEach((t=>{this.graphs[t].on("cell:mousedown",this.onDragStart,this)}))}stopListening(){this.undelegateEvents(),Object.keys(this.graphs).forEach((t=>{this.graphs[t].off("cell:mousedown",this.onDragStart,this)}))}loadGroup(t,n,i){const o=this.getModel(n);if(o){const n=t.map((t=>e.Node.isNode(t)?t:e.Node.create(t)));!0===i?o.removeCells(n):o.resetCells(n)}const s=this.getGroup(n);let a=this.options.stencilGraphHeight;s&&null!=s.graphHeight&&(a=s.graphHeight);const r=s&&s.layout||this.options.layout;if(r&&o&&e.FunctionExt.call(r,this,o,s),!a){const t=this.getGraph(n);t.fitToContent({minWidth:t.options.width,gridHeight:1,padding:s&&s.graphPadding||this.options.stencilGraphPadding||10})}return this}onDragStart(t){const{e:e,node:n}=t,i=this.getGroupByNode(n);i&&!1===i.nodeMovable||this.dnd.start(n,e)}filter(t,n){const i=Object.keys(this.graphs).reduce(((i,o)=>{const s=this.graphs[o],a=o===r.defaultGroupName?null:o,l=s.model.getNodes().filter((i=>{let o=!1;o="function"==typeof n?e.FunctionExt.call(n,this,i,t,a,this):"boolean"==typeof n?n:this.isCellMatched(i,t,n,t.toLowerCase()!==t);const r=s.renderer.findViewByCell(i);return r&&e.Dom.toggleClass(r.container,"unmatched",!o),o})),d=l.length>0,g=this.options,p=new e.Model;return p.resetCells(l),g.layout&&e.FunctionExt.call(g.layout,this,p,this.getGroup(o)),this.groups[o]&&e.Dom.toggleClass(this.groups[o],"unmatched",!d),s.fitToContent({gridWidth:1,gridHeight:1,padding:g.stencilGraphPadding||10}),i||d}),!1);e.Dom.toggleClass(this.container,"not-found",!i)}isCellMatched(t,e,n,i){return!e||!n||Object.keys(n).some((o=>{if("*"===o||t.shape===o){const s=n[o];if("boolean"==typeof s)return s;return(Array.isArray(s)?s:[s]).some((n=>{let o=t.getPropByPath(n);return null!=o&&(o=`${o}`,i||(o=o.toLowerCase()),o.indexOf(e)>=0)}))}return!1}))}onSearch(t){this.filter(t.target.value,this.options.search)}onSearchFocusIn(){e.Dom.addClass(this.container,"is-focused")}onSearchFocusOut(){e.Dom.removeClass(this.container,"is-focused")}onTitleClick(){this.options.collapsable&&(e.Dom.toggleClass(this.container,"collapsed"),e.Dom.hasClass(this.container,"collapsed")?this.collapseGroups():this.expandGroups())}onGroupTitleClick(t){const n=t.target.closest(`.${this.prefixClassName(a.group)}`);n&&this.toggleGroup(e.Dom.attr(n,"data-name")||"");const i=Object.keys(this.groups).every((t=>{const n=this.getGroup(t),i=this.groups[t];return n&&!1===n.collapsable||e.Dom.hasClass(i,"collapsed")}));e.Dom.toggleClass(this.container,"collapsed",i)}getModel(t){const e=this.getGraph(t);return e?e.model:null}getGraph(t){return this.graphs[t||r.defaultGroupName]}getGroup(t){const e=this.options.groups;return null!=t&&e&&e.length?e.find((e=>e.name===t)):null}getGroupByNode(t){const e=this.options.groups;return e?e.find((e=>{const n=this.getModel(e.name);return!!n&&n.has(t.id)})):null}clearGroups(){Object.keys(this.graphs).forEach((t=>{this.graphs[t].dispose()})),Object.keys(this.groups).forEach((t=>{const n=this.groups[t];e.Dom.remove(n)})),this.graphs={},this.groups={}}onRemove(){this.clearGroups(),this.dnd.remove(),this.stopListening(),this.undelegateDocumentEvents()}dispose(){this.remove(),e.CssLoader.clean(this.name)}}var a,r;!function(t,e,n,i){var o,s=arguments.length,a=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,i);else for(var r=t.length-1;r>=0;r--)(o=t[r])&&(a=(s<3?o(a):s>3?o(e,n,a):o(e,n))||a);s>3&&a&&Object.defineProperty(e,n,a)}([e.View.dispose()],s.prototype,"dispose",null),function(t){t.defaultOptions=Object.assign({stencilGraphWidth:200,stencilGraphHeight:800,title:"Stencil",collapsable:!1,placeholder:"Search",notFoundText:"No matches found",layout(t,i){const o={columnWidth:this.options.stencilGraphWidth/2-10,columns:2,rowHeight:80,resizeToFit:!1,dx:10,dy:10};!function(t,i={}){const o=e.Model.isModel(t)?t:(new e.Model).resetCells(t,{sort:!1,dryrun:!0}),s=o.getNodes(),a=i.columns||1,r=Math.ceil(s.length/a),l=i.dx||0,d=i.dy||0,g=!1!==i.center,p=!0===i.resizeToFit,c=i.marginX||0,h=i.marginY||0,u=[];let m=i.columnWidth;if("compact"===m)for(let t=0;t<a;t+=1){const e=n.getNodesInColumn(s,t,a);u.push(n.getMaxDim(e,"width")+l)}else{null!=m&&"auto"!==m||(m=n.getMaxDim(s,"width")+l);for(let t=0;t<a;t+=1)u.push(m)}const x=n.accumulate(u,c),f=[];let b=i.rowHeight;if("compact"===b)for(let t=0;t<r;t+=1){const e=n.getNodesInRow(s,t,a);f.push(n.getMaxDim(e,"height")+d)}else{null!=b&&"auto"!==b||(b=n.getMaxDim(s,"height")+d);for(let t=0;t<r;t+=1)f.push(b)}const w=n.accumulate(f,h);o.startBatch("layout"),s.forEach(((t,e)=>{const n=e%a,o=Math.floor(e/a),s=u[n],r=f[o];let c=0,h=0,m=t.getSize();if(p){let e=s-2*l,n=r-2*d;const o=m.height*(m.width?e/m.width:1),a=m.width*(m.height?n/m.height:1);r<o?e=a:n=o,m={width:e,height:n},t.setSize(m,i)}g&&(c=(s-m.width)/2,h=(r-m.height)/2),t.position(x[n]+l+c,w[o]+d+h,i)})),o.stopBatch("layout")}(t,Object.assign(Object.assign(Object.assign({},o),this.options.layoutOptions),i?i.layoutOptions:{}))}},o.defaults)}(s||(s={})),function(t){t.base="widget-stencil",t.title=`${t.base}-title`,t.search=`${t.base}-search`,t.searchText=`${t.search}-text`,t.content=`${t.base}-content`,t.group=`${t.base}-group`,t.groupTitle=`${t.group}-title`,t.groupContent=`${t.group}-content`}(a||(a={})),function(t){t.defaultGroupName="__default__"}(r||(r={})),t.Stencil=s}));
//# sourceMappingURL=index.js.map
